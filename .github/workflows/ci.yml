name: CI Pipeline

on:
  pull_request:

jobs:
  # ---------- Preflight Checks ----------

  lockfile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.2

      - name: Verify bun.lock is up to date
        timeout-minutes: 3
        run: |
          if bun install --frozen-lockfile > /dev/null 2>&1; then
            echo "Lockfile OK ✔"
          else
            echo "::error::❌ bun.lockb is out of sync with package.json. Please run 'bun install'."
            exit 1
          fi

  prettier:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.2

      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Check Prettier formatting
        run: |
          if bun run format:check; then
            echo "Prettier formatting OK ✔"
          else
            echo "::error::❌ Prettier formatting check failed. Please run 'bun run format'."
            exit 1
          fi

  graphql-schema:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.2

      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Generate GraphQL schema
        run: bun run --cwd clyde-server generate-schema
      - name: Check GraphQL schema up to date
        run: |
          if git diff --exit-code clyde-server/schema.graphql > /dev/null 2>&1; then
            echo "GraphQL schema is up to date ✔"
          else
            echo "::error::❌ GraphQL schema is out of date. Please run 'bun run --cwd clyde-server generate-schema'."
            exit 1
          fi

  # ---------- Preflight Barrier ----------

  # TODO: add changed workspace detection
  preflight:
    needs: [lockfile, prettier, graphql-schema]
    runs-on: ubuntu-latest
    steps:
      - name: Preflight checks passed
        run: |
          echo "All preflight checks passed ✔"
          echo "Proceeding to further jobs..."

  # ---------- Workspace CI Checks ----------

name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  # ---------- Preflight Checks ----------

  lockfile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.2

      - name: Cache bun modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            clyde-bot/node_modules
            clyde-dashboard/node_modules
            clyde-server/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Verify bun.lock is up to date
        timeout-minutes: 3
        run: |
          if bun install --frozen-lockfile > /dev/null 2>&1; then
            echo "Lockfile OK ✔"
          else
            echo "::error::❌ bun.lock is out of sync with package.json. Please run 'bun install'."
            exit 1
          fi

  prettier:
    needs: lockfile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.2

      - name: Cache bun modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            clyde-bot/node_modules
            clyde-dashboard/node_modules
            clyde-server/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check Prettier formatting
        run: |
          if bun run format:check; then
            echo "Prettier formatting OK ✔"
          else
            echo "::error::❌ Prettier formatting check failed. Please run 'bun run format'."
            exit 1
          fi

  graphql-schema:
    needs: lockfile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.2

      - name: Cache bun modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            clyde-bot/node_modules
            clyde-dashboard/node_modules
            clyde-server/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate GraphQL schema
        run: bun run --cwd clyde-server generate-schema
      - name: Check GraphQL schema up to date
        run: |
          if git diff --exit-code clyde-server/schema.graphql > /dev/null 2>&1; then
            echo "GraphQL schema is up to date ✔"
          else
            echo "::error::❌ GraphQL schema is out of date. Please run 'bun run --cwd clyde-server generate-schema'."
            exit 1
          fi

  graphql-codegen:
    needs: lockfile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.2

      - name: Cache bun modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            clyde-bot/node_modules
            clyde-dashboard/node_modules
            clyde-server/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run GraphQL codegen
        run: bun run --cwd clyde-bot codegen
      - name: Check GraphQL codegen up to date
        run: |
          if git diff --exit-code clyde-bot/src/graphql/generated.ts > /dev/null 2>&1; then
            echo "GraphQL codegen is up to date ✔"
          else
            echo "::error::❌ GraphQL codegen is out of date. Please run 'bun run --cwd clyde-bot codegen'."
            exit 1
          fi

  dashboard-lint:
    needs: lockfile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.2

      - name: Cache bun modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            clyde-bot/node_modules
            clyde-dashboard/node_modules
            clyde-server/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run dashboard linter
        run: |
          if bun run --cwd clyde-dashboard lint; then
            echo "Dashboard linting passed ✔"
          else
            echo "::error::❌ Dashboard linting failed. Please fix the linting errors."
            exit 1
          fi

  server-lint:
    needs: lockfile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.2

      - name: Cache bun modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            clyde-bot/node_modules
            clyde-dashboard/node_modules
            clyde-server/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run server linter
        run: |
          if bun run --cwd clyde-server lint; then
            echo "Server linting passed ✔"
          else
            echo "::error::❌ Server linting failed. Please fix the linting errors."
            exit 1
          fi

  # ---------- Preflight Barrier ----------

  # TODO: add changed workspace detection
  preflight:
    needs: [lockfile, prettier, graphql-schema, graphql-codegen, dashboard-lint]
    runs-on: ubuntu-latest
    steps:
      - name: Preflight checks passed
        run: |
          echo "All preflight checks passed ✔"
          echo "Proceeding to further jobs..."

  # ---------- Workspace CI Checks ----------

name: Create Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Determine release tag
        id: tag
        run: |
          set -euo pipefail

          date_prefix="$(TZ=America/New_York date +v%Y.%m.%d)"
          max=-1
          for tag in $(git tag -l "${date_prefix}.*"); do
            nn="${tag##*.}"
            if [[ "$nn" =~ ^[0-9]{2}$ ]]; then
              if ((10#$nn > max)); then
                max=$((10#$nn))
              fi
            fi
          done

          if ((max >= 99)); then
            echo "::error::Release counter exhausted for ${date_prefix}"
            exit 1
          fi

          next=$((max + 1))
          tag_name="$(printf "%s.%02d" "$date_prefix" "$next")"
          if git rev-parse "$tag_name" >/dev/null 2>&1; then
            echo "::error::Tag ${tag_name} already exists."
            exit 1
          fi

          echo "tag_name=${tag_name}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: ${{ steps.tag.outputs.tag_name }}
          generate_release_notes: true
